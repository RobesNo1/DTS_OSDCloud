# =======================
# Custom OSDCloud Landing Page (v1.6 - SetupComplete Replacement Only)
# =======================

# --- OS Selection Variables ---
$OSName       = 'Windows 11 24H2 x64'
$OSEdition    = 'Enterprise'
$OSActivation = 'Retail'
$OSLanguage   = 'en-gb'

# --- Global OSDCloud Settings ---
$Global:MyOSDCloud = [ordered]@{
    Restart                  = $false
    RecoveryPartition        = $true
    OEMActivation            = $true
    WindowsUpdate            = $true
    WindowsUpdateDrivers     = $true
    WindowsDefenderUpdate    = $true
    SetTimeZone              = $true
    ClearDiskConfirm         = $false
    ShutdownSetupComplete    = $false
    SyncMSUpCatDriverUSB     = $true
    CheckSHA1                = $true
}

# --- Info Banner ---
Write-Host "`nStarting OSDCloud for $OSEdition..." -ForegroundColor Yellow
Write-Host ""

# --- Start Deployment ---
Start-OSDCloud -OSName $OSName -OSEdition $OSEdition -OSActivation $OSActivation -OSLanguage $OSLanguage

# --- Post Deployment: SetupComplete Injection ---
Write-Host "`nInjecting custom SetupComplete.cmd from WinPE (X:)..." -ForegroundColor Cyan

# Source in WinPE
$sourceFolder     = "X:\OSDCloud\Config\Scripts\SetupComplete"
$setupCmdSource   = "$sourceFolder\SetupComplete.cmd"

# Target in deployed OS
$targetRoot       = "$env:SystemDrive"
$setupScriptPath  = Join-Path $targetRoot "Windows\Setup\Scripts"
$setupCmdTarget   = Join-Path $setupScriptPath "SetupComplete.cmd"

# Ensure target folder exists
if (-not (Test-Path $setupScriptPath)) {
    New-Item -ItemType Directory -Path $setupScriptPath -Force | Out-Null
    Write-Host "✔ Created folder: $setupScriptPath"
}

# Copy SetupComplete.cmd
if (Test-Path $setupCmdSource) {
    Copy-Item -Path $setupCmdSource -Destination $setupCmdTarget -Force
    Write-Host "✔ Custom SetupComplete.cmd copied to $setupScriptPath"
} else {
    Write-Host "⚠ SetupComplete.cmd not found at $setupCmdSource" -ForegroundColor Red
}

# --- Reboot ---
Write-Host "`nDeployment complete. Press any key to reboot into OOBE..." -ForegroundColor Green
[void][System.Console]::ReadKey($true)
wpeutil reboot
